name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v0.3.0-beta.4)'
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always

jobs:
  # Build uniffi library for supported platforms
  build-uniffi:
    name: Build uniffi (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x64
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            lib_name: librgblibuniffi.so
          # macOS ARM64 (Apple Silicon)
          - target: aarch64-apple-darwin
            os: macos-latest
            lib_name: librgblibuniffi.dylib

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: ${{ matrix.target }}

      - name: Build uniffi library
        working-directory: bindings/uniffi
        run: cargo build --release --target ${{ matrix.target }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: uniffi-${{ matrix.target }}
          path: |
            target/${{ matrix.target }}/release/${{ matrix.lib_name }}
          retention-days: 5

  # Build C-FFI library for supported platforms
  build-cffi:
    name: Build c-ffi (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x64
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            lib_name_static: librgblibcffi.a
            lib_name_shared: librgblibcffi.so
          # macOS ARM64 (Apple Silicon)
          - target: aarch64-apple-darwin
            os: macos-latest
            lib_name_static: librgblibcffi.a
            lib_name_shared: librgblibcffi.dylib

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: ${{ matrix.target }}

      - name: Build c-ffi library
        working-directory: bindings/c-ffi
        run: cargo build --release --target ${{ matrix.target }}

      - name: Upload static library artifact
        uses: actions/upload-artifact@v4
        with:
          name: cffi-static-${{ matrix.target }}
          path: target/${{ matrix.target }}/release/${{ matrix.lib_name_static }}
          retention-days: 5

      - name: Upload shared library artifact
        uses: actions/upload-artifact@v4
        with:
          name: cffi-shared-${{ matrix.target }}
          path: target/${{ matrix.target }}/release/${{ matrix.lib_name_shared }}
          retention-days: 5

  # Generate header file for C-FFI
  generate-header:
    name: Generate C header
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Generate header
        working-directory: bindings/c-ffi
        run: cargo build

      - name: Upload header artifact
        uses: actions/upload-artifact@v4
        with:
          name: cffi-header
          path: bindings/c-ffi/target/rgblibcffi.h
          retention-days: 5

  # Create GitHub Release with all artifacts
  release:
    name: Create Release
    needs: [build-uniffi, build-cffi, generate-header]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets

          # Package uniffi libraries
          for target in x86_64-unknown-linux-gnu aarch64-apple-darwin; do
            if [ -d "artifacts/uniffi-$target" ]; then
              cd artifacts/uniffi-$target
              zip -r "../../release-assets/rgb-lib-uniffi-$target.zip" .
              cd ../..
            fi
          done

          # Package c-ffi libraries
          for target in x86_64-unknown-linux-gnu aarch64-apple-darwin; do
            if [ -d "artifacts/cffi-static-$target" ] && [ -d "artifacts/cffi-shared-$target" ]; then
              mkdir -p "temp-cffi-$target"
              cp artifacts/cffi-static-$target/* "temp-cffi-$target/" 2>/dev/null || true
              cp artifacts/cffi-shared-$target/* "temp-cffi-$target/" 2>/dev/null || true
              cp artifacts/cffi-header/* "temp-cffi-$target/" 2>/dev/null || true
              cd "temp-cffi-$target"
              zip -r "../release-assets/rgb-lib-cffi-$target.zip" .
              cd ..
              rm -rf "temp-cffi-$target"
            fi
          done

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'rc') }}
          generate_release_notes: true
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Trigger rebuild of rgb-lib-go
  trigger-go-bindings:
    name: Trigger Go bindings rebuild
    needs: release
    runs-on: ubuntu-latest

    steps:
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Trigger rgb-lib-go workflow
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.RGB_LIB_GO_PAT }}
          repository: UTEXO-Protocol/rgb-lib-go
          event-type: rgb-lib-release
          client-payload: |
            {
              "version": "${{ steps.version.outputs.version }}",
              "release_url": "https://github.com/UTEXO-Protocol/rgb-lib/releases/tag/${{ steps.version.outputs.version }}"
            }

